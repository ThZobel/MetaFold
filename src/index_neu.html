<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaFold - Folder Structure & Experiment Manager</title>
    
    <!-- Updated CSS Structure -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/integrations.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- CRITICAL: Layout override to force full width -->
    <link rel="stylesheet" href="css/layout-override.css">
</head>
<body>
    <div class="container">
        <!-- LEFT SIDEBAR - Template Selection (RESTORED) -->
        <div class="sidebar">
            <div class="header">
                <h1>📁 MetaFold</h1>
                
                <div class="template-type-selector">
                    <button class="template-type-btn active" onclick="switchTemplateType('folders')" id="foldersTypeBtn">
                        📂 Folders
                    </button>
                    <button class="template-type-btn" onclick="switchTemplateType('experiments')" id="experimentsTypeBtn">
                        🧪 Experiments
                    </button>
                </div>
                
                <!-- Current User Display -->
                <div id="currentUserDisplay" style="
                    margin: 15px 0;
                    padding: 12px;
                    background: rgba(124, 58, 237, 0.1);
                    border: 1px solid rgba(124, 58, 237, 0.3);
                    border-radius: 8px;
                    text-align: center;
                ">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px;">
                        <div id="currentUserAvatar" style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: #7c3aed;
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 0.7rem;
                        ">U</div>
                        <span id="currentUserName" style="color: #a855f7; font-weight: 600; font-size: 0.9rem;">User</span>
                    </div>
                    <div id="currentUserGroup" style="color: #9ca3af; font-size: 0.8rem;">Default</div>
                </div>
                
                <button class="btn" onclick="showTemplateModal()">New Template</button>
                
                <!-- Switch User Button -->
                <button class="btn btn-secondary" onclick="showSwitchUserModal()" style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>👥</span>
                    <span>Switch User</span>
                </button>
                
                <button class="btn btn-secondary" onclick="showSettingsModal()" style="margin-top: 10px;">⚙️ Settings</button>
            </div>
            
            <!-- TEMPLATE LIST - This was missing proper positioning -->
            <div id="templateList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                    </svg>
                    <p>No templates available yet.<br>Create your first template!</p>
                </div>
            </div>
        </div>

        <!-- RIGHT MAIN CONTENT - Project Manager -->
        <div class="main-content">
            <div class="header">
                <h1>🚀 Project Manager</h1>
                <p>Create and manage your project templates for better organization</p>
            </div>

            <div id="templateDetails" style="display: none;">
                <div class="project-setup">
                    <h3>🎯 Project Setup</h3>
                    <div class="project-input-group">
                        <div>
                            <label for="targetPath">📂 Base Directory:</label>
                            <input type="text" id="targetPath" placeholder="Enter path or browse...">
                        </div>
                        <div>
                            <label for="projectName">📝 Project Name:</label>
                            <input type="text" id="projectName" placeholder="MyProject">
                        </div>
                        <button class="btn btn-secondary" onclick="browsePath()">Browse</button>
                    </div>
                    <p style="color: #9ca3af; font-size: 12px; margin-top: 10px;">
                        Project will be created in: <span id="fullPathPreview">Choose directory and project name</span>
                    </p>

                    <!-- elabFTW Integration Option -->
					<div id="elabftwOption" style="display: none; margin-top: 15px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
						<!-- Auto-sync info message -->
						<div id="elabftwAutoInfo" style="display: none; color: #0369a1; font-weight: 500; margin-bottom: 10px;">
							<span style="color: #059669;">✅</span> Auto-sync to elabFTW is enabled - experiments will be created automatically
						</div>
						
						<!-- Manual sync checkbox -->
						<div id="elabftwManualOption">
							<label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #0369a1;">
								<input type="checkbox" id="sendToElabFTW" style="width: auto;">
								🧪 Send to elabFTW
							</label>
							<small style="color: #0369a1; margin-left: 24px; display: block; margin-top: 4px;">
								Create this experiment in elabFTW with metadata and structure
							</small>
						</div>
						
						<!-- Existing experiment ID field -->
						<div id="elabftwExperimentId" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
							<label for="existingExperimentId" style="display: block; font-weight: 500; color: #0369a1; margin-bottom: 5px;">
								📝 Update Existing Experiment (optional):
							</label>
							<input type="text" id="existingExperimentId" placeholder="Enter experiment ID (e.g., 149)" style="width: 100%; padding: 6px 10px; border: 1px solid #0ea5e9; border-radius: 4px;">
							<small style="color: #0369a1; display: block; margin-top: 4px;">
								If provided, metadata will be added to this existing experiment instead of creating a new one
							</small>
						</div>
					</div>

                    <!-- OMERO Integration Option -->
                    <div id="omeroOption" style="display: none; margin-top: 15px; padding: 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                        <!-- OMERO Status Info -->
                        <div id="omeroStatusInfo" style="margin-bottom: 10px;">
                            <div id="omeroConnectionStatus" style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #92400e;">
                                <span id="omeroStatusIcon">🔬</span>
                                <span id="omeroStatusText">OMERO Status: Checking...</span>
                            </div>
                        </div>

                        <!-- Auto-sync info message -->
                        <div id="omeroAutoInfo" style="display: none; color: #92400e; font-weight: 500; margin-bottom: 10px;">
                            <span style="color: #059669;">✅</span> Auto-sync to OMERO is enabled - datasets will be created automatically
                        </div>
                        
                        <!-- Manual sync checkbox -->
                        <div id="omeroManualOption">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #92400e;">
                                <input type="checkbox" id="sendToOMERO" style="width: auto;">
                                🔬 Send to OMERO
                            </label>
                            <small style="color: #92400e; margin-left: 24px; display: block; margin-top: 4px;">
                                Create this experiment as a dataset in OMERO with metadata annotations
                            </small>
                        </div>
                        
                        <!-- OMERO Group Selection -->
						<div id="omeroGroupSelection" style="margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.4); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2); transition: all 0.3s ease;">
							<label for="omeroGroupSelect" style="display: block; font-weight: 500; color: #92400e; margin-bottom: 6px; font-size: 14px;">
								👥 OMERO Group:
							</label>
							<select id="omeroGroupSelect" onchange="handleOMEROGroupSelection()" style="width: 100%; padding: 8px 12px; border: 1px solid #f59e0b; border-radius: 6px; background: white; color: #374151; font-size: 14px; transition: all 0.3s ease;">
								<option value="">Loading groups...</option>
							</select>
							<small style="color: #92400e; display: block; margin-top: 4px; font-size: 12px;">
								Select a group to filter available projects
							</small>
							<div id="omeroGroupStatus" style="margin-top: 6px; font-size: 12px; font-style: italic; min-height: 16px;"></div>
						</div>

						<!-- OMERO Project Selection -->
						<div id="omeroProjectSelection" style="margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3); transition: all 0.3s ease;">
							<label for="omeroProjectSelect" style="display: block; font-weight: 500; color: #92400e; margin-bottom: 6px; font-size: 14px;">
								📁 OMERO Project (optional):
							</label>
							<select id="omeroProjectSelect" onchange="handleOMEROProjectSelection()" style="width: 100%; padding: 8px 12px; border: 1px solid #f59e0b; border-radius: 6px; background: white; color: #374151; font-size: 14px; transition: all 0.3s ease;">
								<option value="">-- Create standalone dataset --</option>
								<option value="refresh">🔄 Refresh project list</option>
							</select>
							<small style="color: #92400e; display: block; margin-top: 4px; font-size: 12px;">
								Select an existing OMERO project to link the dataset to, or leave empty for standalone dataset
							</small>
						</div>

                        <!-- Dataset Name Override -->
                        <div id="omeroDatasetName" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
                            <label for="omeroDatasetNameInput" style="display: block; font-weight: 500; color: #92400e; margin-bottom: 5px;">
                                🗂️ Dataset Name (optional):
                            </label>
                            <input type="text" id="omeroDatasetNameInput" placeholder="Leave empty to use project name" style="width: 100%; padding: 6px 10px; border: 1px solid #f59e0b; border-radius: 4px;">
                            <small style="color: #92400e; display: block; margin-top: 4px;">
                                Customize the dataset name in OMERO. If empty, uses the project name.
                            </small>
                        </div>

                        <!-- Advanced Options (Collapsible) -->
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 500; color: #92400e; padding: 5px 0;">
                                🔧 Advanced OMERO Options
                            </summary>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px;">
                                <!-- Map Annotations Info -->
                                <div style="margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #92400e;">
                                        <input type="checkbox" id="omeroMapAnnotations" checked disabled style="width: auto;">
                                        🗂️ Include Map Annotations
                                    </label>
                                    <small style="color: #92400e; margin-left: 24px; display: block; margin-top: 4px;">
                                        Metadata will be stored as OMERO Map Annotations for programmatic access (recommended)
                                    </small>
                                </div>

                                <!-- Namespace Selection -->
                                <div style="margin-bottom: 10px;">
                                    <label for="omeroNamespace" style="display: block; font-weight: 500; color: #92400e; margin-bottom: 5px;">
                                        🏷️ Annotation Namespace:
                                    </label>
                                    <input type="text" id="omeroNamespace" value="NFDI4BioImage.MetaFold.ExperimentMetadata" style="width: 100%; padding: 6px 10px; border: 1px solid #f59e0b; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                    <small style="color: #92400e; display: block; margin-top: 4px;">
                                        Namespace for metadata annotations (helps organize and filter annotations)
                                    </small>
                                </div>

                                <!-- Connection Test Button -->
                                <div style="margin-top: 15px; text-align: center;">
                                    <button type="button" onclick="testOMEROConnectionInline()" style="
                                        background: linear-gradient(45deg, #f59e0b, #d97706);
                                        color: white;
                                        border: none;
                                        padding: 8px 16px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                                    " onmouseover="this.style.transform='translateY(-1px)'"
                                       onmouseout="this.style.transform='translateY(0)'">
                                        🔍 Test OMERO Connection
                                    </button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="folder-structure">
                    <h3>📋 Structure Preview:</h3>
                    <div id="folderPreview" class="folder-tree"></div>
                </div>

                <!-- Metadata Form for Experiments -->
                <div id="experimentForm" class="metadata-editor" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>🧪 Fill Experiment Metadata:</h3>
                        <button class="btn btn-secondary btn-small" onclick="saveExperimentTemplate()" style="padding: 6px 12px;" title="Save current metadata values and project paths with this template">
                            💾 Save Template & Paths
                        </button>
                    </div>
                    <div id="experimentFields"></div>
                </div>

                <!-- CRITICAL: Actions MUST be inside main-content -->
                <div class="actions">
                    <button class="btn" onclick="createProject()">🎯 Create Project</button>
                    <button class="btn btn-secondary" onclick="editCurrentTemplate()">✏️ Edit</button>
                    <button class="btn btn-danger" onclick="deleteCurrentTemplate()">🗑️ Delete</button>
                </div>

                <!-- Info Message for additional information -->
                <div id="infoMessage" class="message info-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none;"></div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (Enhanced with OMERO) -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2>⚙️ Settings</h2>
            
            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('general')" id="generalTab">
                    🔧 General
                </button>
                <button class="settings-tab" onclick="switchSettingsTab('elabftw')" id="elabftwTab">
                    🧪 elabFTW
                </button>
                <button class="settings-tab" onclick="switchSettingsTab('omero')" id="omeroTab">
                    🔬 OMERO
                </button>
            </div>

            <!-- General Settings Tab -->
            <div id="generalSettings" class="settings-tab-content active">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="userManagementEnabled" onchange="updateUserManagementSetting()">
                        <span>👥 Enable User Management</span>
                    </label>
                    <small>When disabled, the app runs in simple mode without user selection at startup.</small>
                </div>

                <div class="form-group">
                    <label for="themeSelect">🎨 Theme:</label>
                    <select id="themeSelect" onchange="updateThemeSetting()">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                    <small>Choose your preferred color theme (currently only dark theme is implemented).</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoSaveEnabled" onchange="updateAutoSaveSetting()">
                        <span>💾 Auto-save templates</span>
                    </label>
                    <small>Automatically save template changes without confirmation.</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="showTipsEnabled" onchange="updateShowTipsSetting()">
                        <span>💡 Show tips and hints</span>
                    </label>
                    <small>Display helpful tips and guidance throughout the application.</small>
                </div>
            </div>

            <!-- elabFTW Settings Tab -->
            <div id="elabftwSettings" class="settings-tab-content">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="elabftwEnabled" onchange="updateElabFTWSetting()">
                        <span>🧪 Enable elabFTW Integration</span>
                    </label>
                    <small>Connect MetaFold with your elabFTW electronic lab notebook.</small>
                </div>

                <div id="elabftwConfig" style="display: none;">
                    <div class="form-group">
                        <label for="elabftwServerUrl">🌐 elabFTW Server URL:</label>
                        <input type="url" id="elabftwServerUrl" placeholder="https://your-elabftw-server.com" onchange="updateElabFTWServerUrl()">
                        <small>Full URL to your elabFTW server (including https://)</small>
                    </div>

                    <div class="form-group">
                        <label for="elabftwApiKey">🔑 API Key:</label>
                        <input type="password" id="elabftwApiKey" placeholder="Your elabFTW API key" onchange="updateElabFTWApiKey()">
                        <small>Your personal API key from elabFTW (User Panel → API)</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="elabftwAutoSync" onchange="updateElabFTWAutoSync()">
                            <span>🔄 Auto-sync experiments</span>
                        </label>
                        <small>Automatically create experiments in elabFTW when creating experiment projects.</small>
                    </div>

                    <div class="form-group">
                        <label for="elabftwDefaultCategory">📂 Default Category ID:</label>
                        <input type="number" id="elabftwDefaultCategory" value="0" min="0" onchange="updateElabFTWDefaultCategory()">
                        <small><strong>Hint:</strong> Use <code>0</code> if you don't know the correct category ID. Other valid IDs will also work.</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="elabftwVerifySSL" onchange="updateElabFTWVerifySSL()">
                            <span>🔒 Verify SSL certificates</span>
                        </label>
                        <small>Disable only for development servers with self-signed certificates.</small>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="testElabFTWConnection()">🔍 Test Connection</button>
                        <div id="elabftwConnectionStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- OMERO Settings Tab -->
			<div id="omeroSettings" class="settings-tab-content">
				<div class="form-group">
					<label style="display: flex; align-items: center; gap: 8px;">
						<input type="checkbox" id="omeroEnabled" onchange="updateOMEROSetting()">
						<span>🔬 Enable OMERO Integration</span>
					</label>
					<small>Connect MetaFold with your OMERO image data management system.</small>
				</div>

				<div id="omeroConfig" style="display: none;">
					<div class="form-group">
						<label for="omeroServerUrl">🌐 OMERO Server URL:</label>
						<input type="url" id="omeroServerUrl" placeholder="https://your-omero-server.com" onchange="updateOMEROServerUrl()">
						<small>Full URL to your OMERO.web server (including https://)</small>
					</div>

					<div class="form-group">
						<label for="omeroUsername">👤 Username:</label>
						<input type="text" id="omeroUsername" placeholder="Your OMERO username" onchange="updateOMEROUsername()">
						<small>Your OMERO username for authentication</small>
					</div>

					<div class="form-group">
						<label for="omeroPassword">🔑 Password:</label>
						<input type="password" id="omeroPassword" placeholder="Your OMERO password" onchange="updateOMEROPassword()">
						<small>Your OMERO password (stored locally - use secure setup in production)</small>
					</div>

					<div class="form-group">
						<label style="display: flex; align-items: center; gap: 8px;">
							<input type="checkbox" id="omeroAutoSync" onchange="updateOMEROAutoSync()">
							<span>🔄 Auto-sync experiments</span>
						</label>
						<small>Automatically create datasets in OMERO when creating experiment projects.</small>
					</div>

					<div class="form-group">
						<label for="omeroDefaultProject">📁 Default Project ID:</label>
						<input type="number" id="omeroDefaultProject" placeholder="Leave empty for standalone datasets" onchange="updateOMERODefaultProject()">
						<small>Default OMERO project ID to link new datasets to (optional).</small>
					</div>

					<div class="form-group">
						<label style="display: flex; align-items: center; gap: 8px;">
							<input type="checkbox" id="omeroCreateDatasets" onchange="updateOMEROCreateDatasets()">
							<span>🗂️ Create datasets</span>
						</label>
						<small>Create datasets in OMERO (disable if you only want metadata annotations).</small>
					</div>

					<div class="form-group">
						<label style="display: flex; align-items: center; gap: 8px;">
							<input type="checkbox" id="omeroVerifySSL" onchange="updateOMEROVerifySSL()">
							<span>🔒 Verify SSL certificates</span>
						</label>
						<small>Disable only for development servers with self-signed certificates.</small>
					</div>

					<div class="form-group">
						<button class="btn btn-secondary" onclick="testOMEROConnection()">🔍 Test Connection</button>
						<div id="omeroConnectionStatus" style="margin-top: 10px; display: none;"></div>
					</div>
				</div>
			</div>

            <!-- Settings Actions -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-secondary" onclick="resetSettings()">🔄 Reset to Defaults</button>
                <button class="btn btn-secondary" onclick="exportSettings()">📤 Export</button>
                <button class="btn btn-secondary" onclick="importSettings()">📥 Import</button>
                <button class="btn" onclick="closeSettingsModal()">✅ Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for new/edited template -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTemplateModal()">&times;</span>
            <h2 id="modalTitle">Create New Template</h2>
            
            <div class="form-group">
                <label for="templateName">Template Name:</label>
                <input type="text" id="templateName" placeholder="e.g. Web Project, Photo Shoot, etc.">
            </div>

            <div class="form-group">
                <label for="templateDescription">Description (optional):</label>
                <input type="text" id="templateDescription" placeholder="Brief description of the template">
            </div>

            <div class="form-group">
                <label for="templateType">Template Type:</label>
                <select id="templateType" onchange="toggleTemplateTypeContent()">
                    <option value="folders">📂 Folder Structure</option>
                    <option value="experiment">🧪 Experiment (Folders + Metadata)</option>
                </select>
            </div>

            <!-- Folder Structure Tab -->
            <div id="folderTab" class="tab-content active">
                <div class="form-group">
                    <label for="folderStructure">Folder Structure:</label>
                    <textarea id="folderStructure" placeholder="Enter folder structure (2 spaces = one level deeper):
src/
  components/
  assets/
    images/
    css/
  js/
docs/
tests/
README.md"></textarea>
                </div>
            </div>

            <!-- Experiment Tab -->
            <div id="experimentTab" class="tab-content">
                <div class="tabs">
                    <div class="tab active" onclick="switchModalTab('structure')">Structure</div>
                    <div class="tab" onclick="switchModalTab('metadata')">Metadata</div>
                </div>

                <div id="structureContent" class="tab-content active">
                    <div class="form-group">
                        <label for="experimentStructure">Folder Structure (optional):</label>
                        <textarea id="experimentStructure" placeholder="Experiment folder structure (optional - can be left empty):
data/
  raw/
  processed/
analysis/
results/
  plots/
  reports/
README.md
experiment_log.md"></textarea>
                        <small style="color: #6b7280; margin-top: 5px; display: block;">
                            💡 Tip: Leave this field empty if you only want to create metadata files.
                        </small>
                    </div>
                </div>

                <div id="metadataContent" class="tab-content">
                    <div class="form-group">
                        <label>Metadata Fields:</label>
                        <button class="btn btn-secondary btn-small" onclick="addMetadataField()">+ Add Field</button>
                        <button class="btn btn-secondary btn-small" onclick="loadJsonMetadata()" style="margin-left: 10px;">📂 Load JSON</button>
                    </div>
                    
                    <div id="metadataFields"></div>

                    <div class="metadata-preview">
                        <h4>JSON Preview:</h4>
                        <pre id="jsonPreview">{}</pre>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                <button class="btn" onclick="saveTemplate()">Save</button>
            </div>
        </div>
    </div>

   <!-- JavaScript Modules - Updated with Secure Storage -->
    
    <!-- Basis-Module zuerst -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
	<script src="js/userManager.js"></script>
	<script src="js/loginModal.js"></script>
	<script src="js/userManagementModal.js"></script>
    
    <!-- 🔐 SECURE STORAGE MODULES (NEW) - Must load BEFORE settingsManager -->
    <script src="js/secureStorage.js"></script>
    <script src="js/securityUI.js"></script>
    
    <!-- Settings Manager (Enhanced with Secure Storage) -->
    <script src="js/settingsManager.js"></script>
    
    <!-- 🚀 SECURE INTEGRATION COORDINATOR (NEW) - After settingsManager -->
    <script src="js/secureIntegration.js"></script>
    
    <!-- OMERO Integration Modules - Updated to modular structure -->
    <script src="js/omero/metaFoldOMEROIntegration.js"></script>
	<script src="js/omero/omeroAuth.js"></script>
    <script src="js/omero/omeroAPI.js"></script>
    <script src="js/omero/omeroGroups.js"></script>
    <script src="js/omero/omeroProjects.js"></script>
    <script src="js/omero/omeroAnnotations.js"></script>
    <script src="js/omero/omeroDatasetCreation.js"></script>
    <script src="js/omero/omeroUIIntegration.js"></script>
    <script src="js/omero/omeroTestFunctions.js"></script>
	<script src="js/omero/omeroStepByStepTest.js"></script>
	<script src="js/omero/omeroIntegrationTest.js"></script>
    
    <!-- Template und Form Module -->
    <script src="js/templateManager.js"></script>
    <script src="js/templateTypeManager.js"></script>
    <script src="js/metadataEditor.js"></script>
    <script src="js/experimentForm.js"></script>
    <script src="js/templateModal.js"></script>
    <script src="js/projectManager.js"></script>
	
    <!-- App Initialisierung zuletzt -->
	<script src="js/app.js"></script>

    <!-- FIXED Global Functions -->
    <script>
        // =================== TEMPLATE TYPE MANAGEMENT ===================
        
        window.switchTemplateType = function(type) {
            try {
                if (window.templateTypeManager && window.templateTypeManager.switchType) {
                    window.templateTypeManager.switchType(type);
                }
            } catch (error) {
                console.error('Error in switchTemplateType:', error);
            }
        };

        // =================== TEMPLATE MODAL MANAGEMENT ===================
        
        window.showTemplateModal = function() {
            try {
                if (window.templateModal && window.templateModal.show) {
                    window.templateModal.show();
                }
            } catch (error) {
                console.error('Error in showTemplateModal:', error);
            }
        };

        window.closeTemplateModal = function() {
            try {
                if (window.templateModal && window.templateModal.close) {
                    window.templateModal.close();
                }
            } catch (error) {
                console.error('Error in closeTemplateModal:', error);
            }
        };

        window.toggleTemplateTypeContent = function() {
            try {
                if (window.templateModal && window.templateModal.toggleTypeContent) {
                    window.templateModal.toggleTypeContent();
                }
            } catch (error) {
                console.error('Error in toggleTemplateTypeContent:', error);
            }
        };

        window.switchModalTab = function(tab) {
            try {
                if (window.templateModal && window.templateModal.switchTab) {
                    window.templateModal.switchTab(tab);
                }
            } catch (error) {
                console.error('Error in switchModalTab:', error);
            }
        };

        window.saveTemplate = function() {
            try {
                if (window.templateModal && window.templateModal.save) {
                    window.templateModal.save();
                }
            } catch (error) {
                console.error('Error in saveTemplate:', error);
            }
        };

        // =================== METADATA EDITOR MANAGEMENT ===================
        
        window.addMetadataField = function() {
            try {
                if (window.metadataEditor && window.metadataEditor.addField) {
                    window.metadataEditor.addField();
                }
            } catch (error) {
                console.error('Error in addMetadataField:', error);
            }
        };

        window.loadJsonMetadata = function() {
            try {
                if (window.metadataEditor && window.metadataEditor.loadFromJson) {
                    window.metadataEditor.loadFromJson();
                }
            } catch (error) {
                console.error('Error in loadJsonMetadata:', error);
            }
        };

        // =================== PROJECT MANAGEMENT ===================
        
        window.browsePath = function() {
            try {
                if (window.projectManager && window.projectManager.browsePath) {
                    window.projectManager.browsePath();
                }
            } catch (error) {
                console.error('Error in browsePath:', error);
            }
        };

        window.createProject = function() {
            try {
                if (window.projectManager && window.projectManager.createProject) {
                    window.projectManager.createProject();
                }
            } catch (error) {
                console.error('Error in createProject:', error);
            }
        };

        // =================== TEMPLATE MANAGEMENT ===================
        
        window.editCurrentTemplate = function() {
            try {
                if (window.templateManager && window.templateManager.editCurrent) {
                    window.templateManager.editCurrent();
                }
            } catch (error) {
                console.error('Error in editCurrentTemplate:', error);
            }
        };

        window.deleteCurrentTemplate = function() {
            try {
                if (window.templateManager && window.templateManager.deleteCurrent) {
                    window.templateManager.deleteCurrent();
                }
            } catch (error) {
                console.error('Error in deleteCurrentTemplate:', error);
            }
        };

        // =================== EXPERIMENT FORM MANAGEMENT ===================
        
        window.saveExperimentTemplate = function() {
            try {
                if (window.experimentForm && window.experimentForm.saveTemplate) {
                    window.experimentForm.saveTemplate();
                }
            } catch (error) {
                console.error('Error in saveExperimentTemplate:', error);
            }
        };

        // =================== USER MANAGEMENT ===================
        
        window.showSwitchUserModal = function() {
            try {
                if (window.userManagementModal && window.userManagementModal.show) {
                    console.log('👥 Opening Switch User Modal...');
                    window.userManagementModal.show();
                } else {
                    console.warn('⚠️ User Management Modal not available');
                    alert('User Management not available. Please check if user management is enabled in settings.');
                }
            } catch (error) {
                console.error('Error in showSwitchUserModal:', error);
            }
        };

        window.updateCurrentUserDisplay = function() {
            try {
                const userNameEl = document.getElementById('currentUserName');
                const userGroupEl = document.getElementById('currentUserGroup');
                const userAvatarEl = document.getElementById('currentUserAvatar');
                const userDisplayEl = document.getElementById('currentUserDisplay');
                
                if (!userNameEl || !userGroupEl || !userAvatarEl || !userDisplayEl) {
                    console.warn('⚠️ User display elements not found');
                    return;
                }
                
                // Get current user info
                const userInfo = window.userManager?.getCurrentUserInfo() || {
                    username: 'User',
                    groupname: 'Default',
                    isEnabled: false
                };
                
                console.log('👤 Updating user display:', userInfo);
                
                // Update display elements
                userNameEl.textContent = userInfo.username || 'User';
                userGroupEl.textContent = userInfo.groupname || 'Default';
                
                // Update avatar
                const initials = window.userManager?.getUserInitials ? 
                    window.userManager.getUserInitials(userInfo.username) : 
                    (userInfo.username ? userInfo.username.substring(0, 2).toUpperCase() : 'U');
                const color = window.userManager?.generateUserColor ? 
                    window.userManager.generateUserColor(userInfo.username) : 
                    '#7c3aed';
                
                userAvatarEl.textContent = initials;
                userAvatarEl.style.background = color;
                
                // Show/hide user display based on user management status
                if (userInfo.isEnabled && userInfo.username && userInfo.username !== 'User') {
                    userDisplayEl.style.display = 'block';
                    userDisplayEl.style.opacity = '1';
                } else {
                    // In simple mode, show minimal info
                    userDisplayEl.style.display = 'block';
                    userDisplayEl.style.opacity = '0.7';
                }
            } catch (error) {
                console.error('Error updating user display:', error);
            }
        };

        // =================== SETTINGS MANAGEMENT ===================

        window.showSettingsModal = function() {
            try {
                if (!window.settingsManager) {
                    alert('Settings manager not available');
                    return;
                }
                
                loadSettingsIntoModal();
                document.getElementById('settingsModal').style.display = 'block';
            } catch (error) {
                console.error('Error in showSettingsModal:', error);
            }
        };

        window.closeSettingsModal = function() {
            try {
                document.getElementById('settingsModal').style.display = 'none';
            } catch (error) {
                console.error('Error in closeSettingsModal:', error);
            }
        };

        window.switchSettingsTab = function(tabName) {
            try {
                // Hide all tab contents
                document.querySelectorAll('.settings-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabName + 'Settings').classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            } catch (error) {
                console.error('Error in switchSettingsTab:', error);
            }
        };

        // ENHANCED: loadSettingsIntoModal function
        window.loadSettingsIntoModal = async function() {
            const sm = window.settingsManager;
            if (!sm) {
                console.error('❌ Settings manager not available');
                return;
            }
            
            console.log('🔧 Loading all settings into modal...');
            
            try {
                // General settings with proper async handling
                const userMgmtEl = document.getElementById('userManagementEnabled');
                const themeEl = document.getElementById('themeSelect');
                const autoSaveEl = document.getElementById('autoSaveEnabled');
                const showTipsEl = document.getElementById('showTipsEnabled');
                
                // FIXED: Proper async loading of user management setting
                if (userMgmtEl) {
                    const userMgmtEnabled = await sm.get('general.user_management_enabled');
                    console.log('🔧 Loading user management setting:', userMgmtEnabled);
                    userMgmtEl.checked = userMgmtEnabled === true;
                    console.log('🔧 Checkbox set to:', userMgmtEl.checked);
                }
                
                if (themeEl) themeEl.value = await sm.get('general.theme');
                if (autoSaveEl) autoSaveEl.checked = await sm.get('general.auto_save');
                if (showTipsEl) showTipsEl.checked = await sm.get('general.show_tips');
                
                // elabFTW settings
                const elabftwEnabled = await sm.get('elabftw.enabled');
                const elabftwEnabledEl = document.getElementById('elabftwEnabled');
                const elabftwServerEl = document.getElementById('elabftwServerUrl');
                const elabftwApiEl = document.getElementById('elabftwApiKey');
                const elabftwAutoEl = document.getElementById('elabftwAutoSync');
                const elabftwCatEl = document.getElementById('elabftwDefaultCategory');
                const elabftwSslEl = document.getElementById('elabftwVerifySSL');
                const elabftwConfigEl = document.getElementById('elabftwConfig');
                
                if (elabftwEnabledEl) elabftwEnabledEl.checked = elabftwEnabled;
                if (elabftwServerEl) elabftwServerEl.value = await sm.get('elabftw.server_url');
                if (elabftwApiEl) elabftwApiEl.value = await sm.get('elabftw.api_key');
                if (elabftwAutoEl) elabftwAutoEl.checked = await sm.get('elabftw.auto_sync');
                if (elabftwCatEl) elabftwCatEl.value = await sm.get('elabftw.default_category');
                if (elabftwSslEl) elabftwSslEl.checked = await sm.get('elabftw.verify_ssl');
                
                // Show/hide elabFTW config
                if (elabftwConfigEl) {
                    elabftwConfigEl.style.display = elabftwEnabled ? 'block' : 'none';
                }

                // OMERO settings
                const omeroEnabled = await sm.get('omero.enabled');
                const omeroEnabledEl = document.getElementById('omeroEnabled');
                const omeroServerEl = document.getElementById('omeroServerUrl');
                const omeroUsernameEl = document.getElementById('omeroUsername');
                const omeroPasswordEl = document.getElementById('omeroPassword');
                const omeroAutoEl = document.getElementById('omeroAutoSync');
                const omeroProjectEl = document.getElementById('omeroDefaultProject');
                const omeroDatasetEl = document.getElementById('omeroCreateDatasets');
                const omeroSslEl = document.getElementById('omeroVerifySSL');
                const omeroConfigEl = document.getElementById('omeroConfig');
                
                if (omeroEnabledEl) omeroEnabledEl.checked = omeroEnabled;
                if (omeroServerEl) omeroServerEl.value = await sm.get('omero.server_url');
                if (omeroUsernameEl) omeroUsernameEl.value = await sm.get('omero.username');
                if (omeroPasswordEl) omeroPasswordEl.value = await sm.get('omero.password');
                if (omeroAutoEl) omeroAutoEl.checked = await sm.get('omero.auto_sync');
                if (omeroProjectEl) omeroProjectEl.value = await sm.get('omero.default_project_id');
                if (omeroDatasetEl) omeroDatasetEl.checked = await sm.get('omero.create_datasets');
                if (omeroSslEl) omeroSslEl.checked = await sm.get('omero.verify_ssl');
                
                // Show/hide OMERO config
                if (omeroConfigEl) {
                    omeroConfigEl.style.display = omeroEnabled ? 'block' : 'none';
                }
                
                console.log('✅ All settings loaded into modal successfully');
                
            } catch (error) {
                console.error('❌ Error loading settings into modal:', error);
            }
        };

        // =================== SETTING UPDATE FUNCTIONS - FIXED ===================

        // General Settings
        window.updateUserManagementSetting = async function() {
            const checkbox = document.getElementById('userManagementEnabled');
            if (!checkbox) {
                console.error('❌ userManagementEnabled checkbox not found');
                return;
            }
            
            const enabled = checkbox.checked;
            console.log('🔧 User management setting changed to:', enabled);
            
            try {
                if (!window.settingsManager) {
                    throw new Error('Settings manager not available');
                }
                
                const success = await window.settingsManager.set('general.user_management_enabled', enabled);
                
                if (!success) {
                    throw new Error('Failed to save setting');
                }
                
                console.log('✅ Setting saved successfully');
                
            } catch (error) {
                console.error('❌ Error updating user management setting:', error);
                checkbox.checked = !enabled; // Revert on error
            }
        };

        window.updateThemeSetting = async function() {
            try {
                const theme = document.getElementById('themeSelect').value;
                await window.settingsManager.set('general.theme', theme);
            } catch (error) {
                console.error('Error updating theme:', error);
            }
        };

        window.updateAutoSaveSetting = async function() {
            try {
                const enabled = document.getElementById('autoSaveEnabled').checked;
                await window.settingsManager.set('general.auto_save', enabled);
            } catch (error) {
                console.error('Error updating auto save:', error);
            }
        };

        window.updateShowTipsSetting = async function() {
            try {
                const enabled = document.getElementById('showTipsEnabled').checked;
                await window.settingsManager.set('general.show_tips', enabled);
            } catch (error) {
                console.error('Error updating show tips:', error);
            }
        };

        // =================== ELABFTW SETTINGS - RESTORED MISSING FUNCTIONS ===================

        window.updateElabFTWSetting = async function() {
            try {
                const enabled = document.getElementById('elabftwEnabled').checked;
                await window.settingsManager.set('elabftw.enabled', enabled);
                const configEl = document.getElementById('elabftwConfig');
                if (configEl) {
                    configEl.style.display = enabled ? 'block' : 'none';
                }
                
                // Update UI
                setTimeout(() => {
                    window.updateElabFTWOptions();
                }, 100);
            } catch (error) {
                console.error('Error updating elabFTW setting:', error);
            }
        };

        window.updateElabFTWServerUrl = async function() {
            try {
                const url = document.getElementById('elabftwServerUrl').value;
                await window.settingsManager.set('elabftw.server_url', url);
            } catch (error) {
                console.error('Error updating elabFTW server URL:', error);
            }
        };

        window.updateElabFTWApiKey = async function() {
            try {
                const key = document.getElementById('elabftwApiKey').value;
                await window.settingsManager.set('elabftw.api_key', key);
            } catch (error) {
                console.error('Error updating elabFTW API key:', error);
            }
        };

        // FIXED: Missing updateElabFTWAutoSync function
        window.updateElabFTWAutoSync = async function() {
            try {
                const enabled = document.getElementById('elabftwAutoSync').checked;
                await window.settingsManager.set('elabftw.auto_sync', enabled);
                
                // Update UI to show/hide manual sync options
                setTimeout(() => {
                    window.updateElabFTWOptions();
                }, 100);
            } catch (error) {
                console.error('Error updating elabFTW auto sync:', error);
            }
        };

        // FIXED: Missing updateElabFTWDefaultCategory function
        window.updateElabFTWDefaultCategory = async function() {
            try {
                const category = parseInt(document.getElementById('elabftwDefaultCategory').value);
                await window.settingsManager.set('elabftw.default_category', category);
            } catch (error) {
                console.error('Error updating elabFTW default category:', error);
            }
        };

        window.updateElabFTWVerifySSL = async function() {
            try {
                const enabled = document.getElementById('elabftwVerifySSL').checked;
                await window.settingsManager.set('elabftw.verify_ssl', enabled);
            } catch (error) {
                console.error('Error updating elabFTW verify SSL:', error);
            }
        };

        // FIXED: Missing testElabFTWConnection function  
        window.testElabFTWConnection = async function() {
            const statusDiv = document.getElementById('elabftwConnectionStatus');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.textContent = 'Testing elabFTW connection...';
                statusDiv.className = 'testing';
                
                try {
                    const result = await window.settingsManager.testElabFTWConnection();
                    statusDiv.textContent = result.message;
                    statusDiv.className = result.success ? 'success-message' : 'error-message';
                } catch (error) {
                    statusDiv.textContent = 'Connection test failed: ' + error.message;
                    statusDiv.className = 'error-message';
                }
            }
        };

        // =================== OMERO SETTINGS ===================

        window.updateOMEROSetting = async function() {
            try {
                const enabled = document.getElementById('omeroEnabled').checked;
                await window.settingsManager.set('omero.enabled', enabled);
                const configEl = document.getElementById('omeroConfig');
                if (configEl) {
                    configEl.style.display = enabled ? 'block' : 'none';
                }
                
                // Update UI
                setTimeout(() => {
                    window.updateOMEROOptions();
                }, 100);
            } catch (error) {
                console.error('Error updating OMERO setting:', error);
            }
        };

        window.updateOMEROServerUrl = async function() {
            try {
                const url = document.getElementById('omeroServerUrl').value;
                await window.settingsManager.set('omero.server_url', url);
            } catch (error) {
                console.error('Error updating OMERO server URL:', error);
            }
        };

        window.updateOMEROUsername = async function() {
            try {
                const username = document.getElementById('omeroUsername').value;
                await window.settingsManager.set('omero.username', username);
            } catch (error) {
                console.error('Error updating OMERO username:', error);
            }
        };

        window.updateOMEROPassword = async function() {
            try {
                const password = document.getElementById('omeroPassword').value;
                await window.settingsManager.set('omero.password', password);
            } catch (error) {
                console.error('Error updating OMERO password:', error);
            }
        };

        window.updateOMEROAutoSync = async function() {
            try {
                const enabled = document.getElementById('omeroAutoSync').checked;
                await window.settingsManager.set('omero.auto_sync', enabled);
                
                // Update UI
                setTimeout(() => {
                    window.updateOMEROOptions();
                }, 100);
            } catch (error) {
                console.error('Error updating OMERO auto sync:', error);
            }
        };

        window.updateOMERODefaultProject = async function() {
            try {
                const projectId = document.getElementById('omeroDefaultProject').value;
                await window.settingsManager.set('omero.default_project_id', projectId);
            } catch (error) {
                console.error('Error updating OMERO default project:', error);
            }
        };

        window.updateOMEROCreateDatasets = async function() {
            try {
                const enabled = document.getElementById('omeroCreateDatasets').checked;
                await window.settingsManager.set('omero.create_datasets', enabled);
            } catch (error) {
                console.error('Error updating OMERO create datasets:', error);
            }
        };

        window.updateOMEROVerifySSL = async function() {
            try {
                const enabled = document.getElementById('omeroVerifySSL').checked;
                await window.settingsManager.set('omero.verify_ssl', enabled);
            } catch (error) {
                console.error('Error updating OMERO verify SSL:', error);
            }
        };

        window.testOMEROConnection = async function() {
            const statusDiv = document.getElementById('omeroConnectionStatus');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.textContent = 'Testing OMERO connection...';
                statusDiv.className = 'testing';
                
                try {
                    const result = await window.settingsManager.testOMEROConnection();
                    statusDiv.textContent = result.message;
                    statusDiv.className = result.success ? 'success-message' : 'error-message';
                } catch (error) {
                    statusDiv.textContent = 'OMERO connection test failed: ' + error.message;
                    statusDiv.className = 'error-message';
                }
            }
        };

        // =================== SETTINGS UTILITY FUNCTIONS ===================

        window.resetSettings = function() {
            if (confirm('Reset all settings to defaults? This cannot be undone.')) {
                window.settingsManager.reset();
                loadSettingsIntoModal();
                showSettingsMessage('Settings reset to defaults.', 'success');
            }
        };

        window.exportSettings = function() {
            const settings = window.settingsManager.export();
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'metafold-settings.json';
            a.click();
            
            URL.revokeObjectURL(url);
            showSettingsMessage('Settings exported successfully.', 'success');
        };

        window.importSettings = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const success = window.settingsManager.import(e.target.result);
                        if (success) {
                            loadSettingsIntoModal();
                            showSettingsMessage('Settings imported successfully.', 'success');
                        } else {
                            showSettingsMessage('Failed to import settings.', 'error');
                        }
                    } catch (error) {
                        showSettingsMessage('Invalid settings file.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        };

        window.showSettingsMessage = function(message, type) {
            let messageDiv = document.getElementById('settingsMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'settingsMessage';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10001;
                    font-weight: 500;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                document.body.appendChild(messageDiv);
            }
            
            // Set message and style
            messageDiv.textContent = message;
            messageDiv.className = type + '-message';
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 3000);
        };

        // =================== INTEGRATION UI UPDATE FUNCTIONS ===================

        window.updateElabFTWOptions = async function() {
            try {
                console.log('🧪 UI: Updating elabFTW options visibility');
                
                if (!window.settingsManager) {
                    console.warn('🧪 UI: settingsManager not available');
                    return;
                }
                
                const elabftwOption = document.getElementById('elabftwOption');
                const elabftwAutoInfo = document.getElementById('elabftwAutoInfo');
                const elabftwManualOption = document.getElementById('elabftwManualOption');
                
                if (!elabftwOption || !elabftwAutoInfo || !elabftwManualOption) {
                    console.warn('🧪 UI: elabFTW UI elements not found');
                    return;
                }
                
                const enabled = await window.settingsManager.get('elabftw.enabled');
                const autoSync = await window.settingsManager.get('elabftw.auto_sync');
                const isExperimentMode = window.templateTypeManager && window.templateTypeManager.isExperimentMode();
                
                console.log('🧪 UI: elabFTW Settings:', { enabled, autoSync, isExperimentMode });
                
                if (enabled && isExperimentMode) {
                    elabftwOption.style.display = 'block';
                    
                    if (autoSync) {
                        elabftwAutoInfo.style.display = 'block';
                        elabftwManualOption.style.display = 'none';
                        console.log('🧪 UI: Showing auto-sync info');
                    } else {
                        elabftwAutoInfo.style.display = 'none';
                        elabftwManualOption.style.display = 'block';
                        console.log('🧪 UI: Showing manual sync checkbox');
                    }
                } else {
                    elabftwOption.style.display = 'none';
                    console.log('🧪 UI: Hiding elabFTW options (enabled:', enabled, ', experiment mode:', isExperimentMode, ')');
                }
            } catch (error) {
                console.error('🧪 UI: Error updating elabFTW options:', error);
            }
        };

        window.updateOMEROOptions = async function() {
            try {
                console.log('🔬 UI: Updating OMERO options visibility');
                
                if (!window.settingsManager) {
                    console.warn('🔬 UI: settingsManager not available');
                    return;
                }
                
                const omeroOption = document.getElementById('omeroOption');
                const omeroAutoInfo = document.getElementById('omeroAutoInfo');
                const omeroManualOption = document.getElementById('omeroManualOption');
                
                if (!omeroOption || !omeroAutoInfo || !omeroManualOption) {
                    console.warn('🔬 UI: OMERO UI elements not found');
                    return;
                }
                
                const enabled = await window.settingsManager.get('omero.enabled');
                const autoSync = await window.settingsManager.get('omero.auto_sync');
                const isExperimentMode = window.templateTypeManager && window.templateTypeManager.isExperimentMode();
                
                console.log('🔬 UI: OMERO Settings:', { enabled, autoSync, isExperimentMode });
                
                if (enabled && isExperimentMode) {
                    omeroOption.style.display = 'block';
                    
                    if (autoSync) {
                        omeroAutoInfo.style.display = 'block';
                        omeroManualOption.style.display = 'none';
                        console.log('🔬 UI: Showing auto-sync info');
                    } else {
                        omeroAutoInfo.style.display = 'none';
                        omeroManualOption.style.display = 'block';
                        console.log('🔬 UI: Showing manual sync checkbox');
                    }
                    
                    // Update OMERO status if available
                    if (window.updateOMEROStatus) {
                        window.updateOMEROStatus();
                    }
                } else {
                    omeroOption.style.display = 'none';
                    console.log('🔬 UI: Hiding OMERO options (enabled:', enabled, ', experiment mode:', isExperimentMode, ')');
                }
            } catch (error) {
                console.error('🔬 UI: Error updating OMERO options:', error);
            }
        };

        window.updateIntegrationOptions = async function() {
            try {
                console.log('🔄 UI: Updating all integration options');
                await window.updateElabFTWOptions();
                await window.updateOMEROOptions();
            } catch (error) {
                console.error('Error updating integration options:', error);
            }
        };

        // =================== OMERO UI HANDLERS ===================

        window.handleOMEROGroupSelection = function() {
            if (window.omeroUIIntegration && window.omeroUIIntegration.handleGroupSelection) {
                window.omeroUIIntegration.handleGroupSelection();
            } else {
                console.warn('OMERO UI Integration not available for group selection');
            }
        };

        window.handleOMEROProjectSelection = function() {
            if (window.omeroUIIntegration && window.omeroUIIntegration.handleProjectSelection) {
                window.omeroUIIntegration.handleProjectSelection();
            } else {
                console.warn('OMERO UI Integration not available for project selection');
            }
        };

        window.loadOMEROProjects = async function() {
            if (!window.omeroUIIntegration) return;
            
            try {
                await window.omeroUIIntegration.loadGroupsForDropdown();
            } catch (error) {
                console.error('Error loading OMERO groups and projects:', error);
                if (window.omeroUIIntegration.loadProjectsForDropdown) {
                    window.omeroUIIntegration.loadProjectsForDropdown();
                }
            }
        };

        window.updateOMEROStatus = async function() {
            if (window.omeroUIIntegration && window.omeroUIIntegration.updateStatusDisplay) {
                window.omeroUIIntegration.updateStatusDisplay();
            }
        };

        window.testOMEROConnectionInline = async function() {
            if (!window.omeroUIIntegration) {
                alert('OMERO UI integration not available');
                return;
            }
            
            try {
                const result = await window.omeroUIIntegration.testConnection();
                
                if (result.success) {
                    alert(`✅ OMERO Connection Successful!\n\n${result.message}\n\nDetails:\n- Proxy URL: ${result.details?.proxyUrl || 'Unknown'}\n- Projects: ${result.details?.projectCount || 0}\n- Auth Method: ${result.details?.authMethod || 'Unknown'}`);
                    
                    // Refresh project list after successful connection
                    if (window.loadOMEROProjects) {
                        window.loadOMEROProjects();
                    }
                } else {
                    alert(`❌ OMERO Connection Failed!\n\n${result.message}\n\n${result.details?.guidance || 'Check console for more details.'}`);
                }
                
                // Update status display
                if (window.updateOMEROStatus) {
                    window.updateOMEROStatus();
                }
                
            } catch (error) {
                console.error('OMERO connection test error:', error);
                alert(`❌ OMERO Connection Test Failed!\n\nError: ${error.message}\n\nCheck console for details.`);
            }
        };

        // =================== EVENT LISTENERS & INITIALIZATION ===================

        // Close settings modal on click outside
        window.addEventListener('click', function(event) {
            try {
                const modal = document.getElementById('settingsModal');
                if (event.target === modal) {
                    closeSettingsModal();
                }
            } catch (error) {
                console.error('Error in click listener:', error);
            }
        });

        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Wait for userManager to be ready
                setTimeout(() => {
                    window.updateCurrentUserDisplay();
                }, 1000);

                setTimeout(() => {
                    console.log('🔄 UI: Initial integration options update');
                    if (window.updateIntegrationOptions) {
                        window.updateIntegrationOptions();
                    }
                }, 500);
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        // Update display when userManager initializes
        if (window.userManager) {
            const originalInit = window.userManager.init;
            if (originalInit) {
                window.userManager.init = async function() {
                    try {
                        const result = await originalInit.call(this);
                        
                        // Update display after initialization
                        setTimeout(() => {
                            window.updateCurrentUserDisplay();
                        }, 200);
                        
                        return result;
                    } catch (error) {
                        console.error('Error in enhanced userManager init:', error);
                        throw error;
                    }
                };
            }
        }

        console.log('✅ LAYOUT FIXED MetaFold UI Integration loaded successfully');
    </script>

</body>
</html>